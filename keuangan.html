<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pengatur Keuangan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .lucide {
            width: 1em;
            height: 1em;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Catatan Keuangan</h1>
            <p class="text-gray-600 mt-2">Atur pemasukan dan pengeluaran Anda dengan mudah.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Kolom Kiri: Ringkasan & Form -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Ringkasan Keuangan -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Ringkasan</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Pemasukan</span>
                            <span id="total-pemasukan" class="font-semibold text-green-600 text-lg">Rp 0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Pengeluaran</span>
                            <span id="total-pengeluaran" class="font-semibold text-red-600 text-lg">Rp 0</span>
                        </div>
                        <hr class="my-2 border-t-2 border-dashed">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-lg">Saldo</span>
                            <span id="saldo-saat-ini" class="font-bold text-blue-600 text-xl">Rp 0</span>
                        </div>
                    </div>
                </div>

                <!-- Form Tambah Transaksi -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Tambah Transaksi</h2>
                    <form id="transaction-form" class="space-y-4">
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700">Deskripsi</label>
                            <input type="text" id="description" placeholder="Contoh: Gaji bulanan" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700">Jumlah (Rp)</label>
                            <input type="number" id="amount" placeholder="Contoh: 50000" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Tipe Transaksi</label>
                            <div class="mt-2 grid grid-cols-2 gap-3">
                                <div>
                                    <label for="type-income" class="border rounded-md p-3 flex items-center justify-center text-sm font-medium cursor-pointer has-[:checked]:bg-green-50 has-[:checked]:border-green-300 has-[:checked]:text-green-900">
                                        <input type="radio" name="type" id="type-income" value="pemasukan" class="sr-only" checked>
                                        <span>Pemasukan</span>
                                    </label>
                                </div>
                                <div>
                                    <label for="type-expense" class="border rounded-md p-3 flex items-center justify-center text-sm font-medium cursor-pointer has-[:checked]:bg-red-50 has-[:checked]:border-red-300 has-[:checked]:text-red-900">
                                        <input type="radio" name="type" id="type-expense" value="pengeluaran" class="sr-only">
                                        <span>Pengeluaran</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                            Tambah
                        </button>
                    </form>
                    <div id="auth-status" class="mt-4 text-xs text-center text-gray-500">Menyambungkan...</div>
                </div>
            </div>

            <!-- Kolom Kanan: Riwayat Transaksi -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold mb-4">Riwayat Transaksi</h2>
                
                <!-- Filter Waktu -->
                <div class="mb-4 overflow-x-auto no-scrollbar">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                            <button data-filter="semua" class="filter-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600">Semua</button>
                            <button data-filter="harian" class="filter-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">Harian</button>
                            <button data-filter="mingguan" class="filter-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">Mingguan</button>
                            <button data-filter="bulanan" class="filter-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">Bulanan</button>
                        </nav>
                    </div>
                </div>

                <!-- Ringkasan Periode -->
                <div id="period-summary" class="bg-gray-50 p-4 rounded-lg mb-4 hidden">
                    <h3 class="font-semibold text-md mb-3">Ringkasan Periode Terpilih</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-center">
                        <div>
                            <p class="text-sm text-gray-500">Pemasukan</p>
                            <p id="period-income" class="font-bold text-green-600 text-lg">Rp 0</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Pengeluaran</p>
                            <p id="period-expense" class="font-bold text-red-600 text-lg">Rp 0</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Selisih</p>
                            <p id="period-net" class="font-bold text-blue-600 text-lg">Rp 0</p>
                        </div>
                    </div>
                </div>

                <!-- Daftar Transaksi -->
                <div id="transaction-list" class="space-y-3 h-[450px] overflow-y-auto pr-2">
                    <!-- Placeholder akan dipindahkan -->
                </div>

                <!-- Daftar Transaksi Harian (Tabel) -->
                <div id="daily-table-view" class="hidden h-[450px] overflow-y-auto pr-2">
                    <div class="border rounded-lg overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                                    <th scope="col" class="relative px-4 py-3">
                                        <span class="sr-only">Hapus</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="daily-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Baris tabel akan dimasukkan di sini oleh JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Placeholder (dipakai bersama) -->
                <div id="list-placeholder" class="text-center py-16 hidden">
                    <p class="text-gray-500">Belum ada transaksi pada periode ini.</p>
                    <p class="text-sm text-gray-400">Silakan tambahkan transaksi baru.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
            <i data-lucide="trash-2" class="h-6 w-6 text-red-600"></i>
          </div>
          <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Hapus Transaksi</h3>
          <div class="mt-2 px-7 py-3">
            <p class="text-sm text-gray-500">
              Apakah Anda yakin ingin menghapus transaksi ini? Tindakan ini tidak dapat dibatalkan.
            </p>
          </div>
          <div class="items-center px-4 py-3 gap-2 flex justify-center">
            <button id="confirm-delete-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-24 shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
              Hapus
            </button>
            <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-24 shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
              Batal
            </button>
          </div>
        </div>
      </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        
        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Variabel Global
        let transactions = [];
        let currentFilter = 'semua';
        let userId = null;
        let unsubscribe = null; // Untuk listener onSnapshot
        let transactionToDeleteId = null;

        // Elemen DOM
        const form = document.getElementById('transaction-form');
        const totalPemasukanEl = document.getElementById('total-pemasukan');
        const totalPengeluaranEl = document.getElementById('total-pengeluaran');
        const saldoSaatIniEl = document.getElementById('saldo-saat-ini');
        const transactionListEl = document.getElementById('transaction-list');
        const listPlaceholder = document.getElementById('list-placeholder');
        const authStatusEl = document.getElementById('auth-status');
        const filterButtons = document.querySelectorAll('.filter-btn');

        const dailyTableView = document.getElementById('daily-table-view');
        const dailyTableBody = document.getElementById('daily-table-body');

        const periodSummaryEl = document.getElementById('period-summary');
        const periodIncomeEl = document.getElementById('period-income');
        const periodExpenseEl = document.getElementById('period-expense');
        const periodNetEl = document.getElementById('period-net');

        // Modal Elements
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        
        // Fungsi Helper
        const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);

        const formatDate = (timestamp) => {
            if (!timestamp) return 'Tanggal tidak valid';
            return timestamp.toDate().toLocaleDateString('id-ID', {
                day: '2-digit', month: 'short', year: 'numeric'
            });
        };

        // Fungsi Render
        function renderTransactions() {
            // Logika untuk menampilkan view yang sesuai
            listPlaceholder.classList.add('hidden');
            if (currentFilter === 'harian') {
                dailyTableView.classList.remove('hidden');
                transactionListEl.classList.add('hidden');
            } else {
                dailyTableView.classList.add('hidden');
                transactionListEl.classList.remove('hidden');
            }

            if (currentFilter === 'semua') {
                periodSummaryEl.classList.add('hidden');
            } else {
                periodSummaryEl.classList.remove('hidden');
            }

            transactionListEl.innerHTML = '';
            dailyTableBody.innerHTML = '';
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());

            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            // Urutkan transaksi dari yang terbaru
            const sortedTransactions = [...transactions].sort((a, b) => b.date.seconds - a.date.seconds);

            const filteredTransactions = sortedTransactions.filter(trx => {
                const trxDate = trx.date.toDate();
                switch (currentFilter) {
                    case 'harian':
                        return trxDate >= today;
                    case 'mingguan':
                        return trxDate >= startOfWeek;
                    case 'bulanan':
                        return trxDate >= startOfMonth;
                    case 'semua':
                    default:
                        return true;
                }
            });

            // Hitung dan render ringkasan periode
            const periodIncome = filteredTransactions
                .filter(t => t.type === 'pemasukan')
                .reduce((sum, t) => sum + t.amount, 0);

            const periodExpense = filteredTransactions
                .filter(t => t.type === 'pengeluaran')
                .reduce((sum, t) => sum + t.amount, 0);

            const periodNet = periodIncome - periodExpense;
            
            periodIncomeEl.textContent = formatCurrency(periodIncome);
            periodExpenseEl.textContent = formatCurrency(periodExpense);
            periodNetEl.textContent = formatCurrency(periodNet);
            periodNetEl.className = `font-bold text-lg ${periodNet >= 0 ? 'text-blue-600' : 'text-red-600'}`;


            if (filteredTransactions.length === 0) {
                listPlaceholder.classList.remove('hidden');
                if (currentFilter === 'harian') {
                    dailyTableView.classList.add('hidden');
                } else {
                    transactionListEl.classList.add('hidden');
                }
            } else {
                 if (currentFilter === 'harian') {
                    dailyTableView.classList.remove('hidden');
                } else {
                    transactionListEl.classList.remove('hidden');
                }
            }

            // Render view berdasarkan filter
            if (currentFilter === 'harian') {
                renderDailyTable(filteredTransactions);
            } else {
                renderTransactionList(filteredTransactions);
            }

            // Re-render icons after updating innerHTML
            lucide.createIcons();
        }

        function renderTransactionList(transactionsToRender) {
             transactionsToRender.forEach(trx => {
                const isIncome = trx.type === 'pemasukan';
                const sign = isIncome ? '+' : '-';
                const amountColor = isIncome ? 'text-green-600' : 'text-red-600';
                const borderColor = isIncome ? 'border-green-200' : 'border-red-200';
                const icon = isIncome ? 
                    `<i data-lucide="arrow-down-left" class="w-5 h-5 text-green-500 bg-green-100 rounded-full p-1"></i>` : 
                    `<i data-lucide="arrow-up-right" class="w-5 h-5 text-red-500 bg-red-100 rounded-full p-1"></i>`;

                const li = document.createElement('div');
                li.className = `flex items-center justify-between p-3 rounded-lg border ${borderColor} bg-gray-50/50`;
                li.innerHTML = `
                    <div class="flex items-center gap-4">
                        ${icon}
                        <div>
                            <p class="font-semibold text-gray-800">${trx.description}</p>
                            <p class="text-xs text-gray-500">${formatDate(trx.date)}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-semibold ${amountColor}">${sign} ${formatCurrency(trx.amount)}</span>
                        <button class="delete-btn text-gray-400 hover:text-red-500" data-id="${trx.id}">
                           <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                transactionListEl.appendChild(li);
            });
        }

        function renderDailyTable(transactionsToRender) {
            transactionsToRender.forEach(trx => {
                const isIncome = trx.type === 'pemasukan';
                const amountColor = isIncome ? 'text-green-600' : 'text-red-600';
                const typeText = isIncome ? 'Pemasukan' : 'Pengeluaran';
                const typeColor = isIncome ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${trx.description}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${typeColor}">
                            ${typeText}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium ${amountColor}">
                        ${formatCurrency(trx.amount)}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button class="delete-btn text-gray-400 hover:text-red-500" data-id="${trx.id}">
                           <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                dailyTableBody.appendChild(row);
            });
        }

        function updateSummary() {
            const totalPemasukan = transactions
                .filter(t => t.type === 'pemasukan')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalPengeluaran = transactions
                .filter(t => t.type === 'pengeluaran')
                .reduce((sum, t) => sum + t.amount, 0);

            const saldo = totalPemasukan - totalPengeluaran;

            totalPemasukanEl.textContent = formatCurrency(totalPemasukan);
            totalPengeluaranEl.textContent = formatCurrency(totalPengeluaran);
            saldoSaatIniEl.textContent = formatCurrency(saldo);
        }
        
        // Fungsi Firestore
        async function addTransaction(e) {
            e.preventDefault();
            const description = document.getElementById('description').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const type = document.querySelector('input[name="type"]:checked').value;

            if (description.trim() === '' || isNaN(amount) || amount <= 0) {
                // simple validation
                return;
            }
            
            if (!userId) {
                console.error("User not authenticated, cannot add transaction.");
                return;
            }

            try {
                const transactionsCol = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                await addDoc(transactionsCol, {
                    description,
                    amount,
                    type,
                    date: Timestamp.now()
                });
                form.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        }

        async function deleteTransaction(id) {
            if (!userId) {
                console.error("User not authenticated, cannot delete transaction.");
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, id));
            } catch (error) {
                console.error("Error deleting document: ", error);
            }
        }
        
        function setupFirestoreListener(uid) {
             if (unsubscribe) {
                unsubscribe(); // Hentikan listener lama jika ada
            }
            const transactionsCol = collection(db, `artifacts/${appId}/users/${uid}/transactions`);
            const q = query(transactionsCol);

            unsubscribe = onSnapshot(q, (querySnapshot) => {
                transactions = [];
                querySnapshot.forEach((doc) => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                updateSummary();
                renderTransactions();
            }, (error) => {
                console.error("Error getting documents: ", error);
            });
        }
        
        // Event Listeners
        form.addEventListener('submit', addTransaction);

        transactionListEl.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                transactionToDeleteId = deleteButton.dataset.id;
                deleteModal.classList.remove('hidden');
            }
        });

        dailyTableView.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                transactionToDeleteId = deleteButton.dataset.id;
                deleteModal.classList.remove('hidden');
            }
        });

        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentFilter = button.dataset.filter;
                
                filterButtons.forEach(btn => {
                    btn.classList.remove('text-blue-600', 'border-blue-600');
                    btn.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
                });
                
                button.classList.add('text-blue-600', 'border-blue-600');
                button.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
                
                renderTransactions();
            });
        });

        // Modal Logic
        confirmDeleteBtn.addEventListener('click', () => {
            if (transactionToDeleteId) {
                deleteTransaction(transactionToDeleteId);
                transactionToDeleteId = null;
                deleteModal.classList.add('hidden');
            }
        });

        cancelDeleteBtn.addEventListener('click', () => {
            transactionToDeleteId = null;
            deleteModal.classList.add('hidden');
        });

        window.onclick = function(event) {
          if (event.target == deleteModal) {
            deleteModal.classList.add('hidden');
          }
        }

        // Inisialisasi Aplikasi
        function initializeAppWithAuth() {
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    authStatusEl.textContent = `ID Pengguna: ${userId.substring(0,8)}...`;
                    authStatusEl.classList.add('text-green-600');
                    setupFirestoreListener(userId);
                } else {
                    userId = null;
                    authStatusEl.textContent = 'Tidak terautentikasi.';
                    authStatusEl.classList.remove('text-green-600');
                    transactions = [];
                    updateSummary();
                    renderTransactions();
                }
            });
        }
        
        // Mulai autentikasi
        async function startAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed: ", error);
                authStatusEl.textContent = 'Gagal autentikasi.';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initializeAppWithAuth();
            startAuth();
        });

    </script>
</body>
</html>

